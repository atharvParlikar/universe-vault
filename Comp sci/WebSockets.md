## Random Notes

- A WebSocket connection starts as a regular HTTP request. This is because most browsers and networking layers only support opening WebSocket connections over HTTP or HTTPS.
    
- The HTTP request has a header indicating that it intends to upgrade to a WebSocket connection. The server then reads that header and replies with an upgrade-acknowledgment header. Once this handshake is completed, the connection is upgraded to a WebSocket connection.
    

Upgrade header example:

```http
GET /index.html HTTP/1.1
Host: www.example.com
Connection: upgrade
Upgrade: websocket
```

---

## WebSocket Connection Process

### Step-by-Step Overview

1. **Initial Request (HTTP)**
    
    - The client sends an HTTP request with specific headers to indicate it wants to establish a WebSocket connection.
    - Key headers:
        - `Connection: Upgrade`
        - `Upgrade: websocket`
        - `Sec-WebSocket-Key`: A randomly generated base64-encoded string.
        - `Sec-WebSocket-Version`: The WebSocket protocol version (typically `13`).
2. **Server Response**
    
    - The server receives the HTTP request and checks the headers.
    - If valid, the server responds with an HTTP status `101 Switching Protocols` to indicate the upgrade.
    - Key headers:
        - `Connection: Upgrade`
        - `Upgrade: websocket`
        - `Sec-WebSocket-Accept`: A hash value derived from the `Sec-WebSocket-Key`.
3. **Handshake Completion**
    
    - Once the client receives the server's `101 Switching Protocols` response, the WebSocket connection is established.
    - Both client and server can now communicate over the persistent WebSocket connection.

---

### ASCII Diagram of the WebSocket Handshake

#### 1. Initial Request

```
Client                                           Server
   |                                                |
   |--- HTTP Request ------------------------------>|
   |   GET /index.html HTTP/1.1                     |
   |   Host: www.example.com                        |
   |   Connection: Upgrade                          |
   |   Upgrade: websocket                           |
   |   Sec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw==  |
   |   Sec-WebSocket-Version: 13                    |
   |                                                |
```

#### 2. Server Response

```
Client                                           Server
   |                                                |
   |<--- HTTP Response -----------------------------|
   |   HTTP/1.1 101 Switching Protocols             |
   |   Upgrade: websocket                           |
   |   Connection: Upgrade                          |
   |   Sec-WebSocket-Accept: HSmrc0sMlYUkAGmm5OP2.. |
   |                                                |
```

#### 3. WebSocket Connection Established

```
Client                                           Server
   |                                                |
   |<==== WebSocket Messages ======================>|
   |                                                |
   |<==== Full-Duplex Communication Begins ========>|
   |                                                |
```

---

### Notes on Headers

- **`Sec-WebSocket-Key`**: A random string sent by the client to ensure that the response is unique.
- **`Sec-WebSocket-Accept`**: Generated by the server using the formula:
    
    ```
    Sec-WebSocket-Accept = BASE64(SHA1(Sec-WebSocket-Key + "258EAFA5-E914-47DA-95CA-C5AB0DC85B11"))
    ```
    
    This ensures the response is valid and matches the client's request.

---

For further details, see:

[MDN HTTP/1.1 Upgrade Mechanism Explained](https://developer.mozilla.org/en-US/docs/Web/HTTP/Protocol_upgrade_mechanism)

